name: 📊 Analytics Bot

on:
  schedule:
    # Her hafta pazartesi saat 09:00'da çalış
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  analytics:
    name: 📊 Project Analytics
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate project analytics
      run: |
        echo "📊 Generating project analytics..."
        
        # Get current date
        CURRENT_DATE=$(date '+%Y-%m-%d')
        
        # Count files by type
        GO_FILES=$(find . -name "*.go" | wc -l)
        YAML_FILES=$(find . -name "*.yml" -o -name "*.yaml" | wc -l)
        MD_FILES=$(find . -name "*.md" | wc -l)
        
        # Count lines of code
        TOTAL_LINES=$(find . -name "*.go" -exec wc -l {} + | tail -1 | awk '{print $1}')
        
        # Get commit statistics
        COMMITS_THIS_WEEK=$(git log --since="1 week ago" --oneline | wc -l)
        COMMITS_THIS_MONTH=$(git log --since="1 month ago" --oneline | wc -l)
        TOTAL_COMMITS=$(git log --oneline | wc -l)
        
        # Get contributor count
        CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
        
        # Get file size statistics
        PROJECT_SIZE=$(du -sh . | cut -f1)
        
        # Create analytics report
        cat > analytics-report-$CURRENT_DATE.md << EOF
        # 📊 Project Analytics Report - $CURRENT_DATE
        
        ## 📈 Code Statistics
        - **Total Go Files:** $GO_FILES
        - **Total Lines of Code:** $TOTAL_LINES
        - **Configuration Files:** $YAML_FILES
        - **Documentation Files:** $MD_FILES
        - **Project Size:** $PROJECT_SIZE
        
        ## 👥 Contribution Statistics
        - **Total Contributors:** $CONTRIBUTORS
        - **Total Commits:** $TOTAL_COMMITS
        - **Commits This Week:** $COMMITS_THIS_WEEK
        - **Commits This Month:** $COMMITS_THIS_MONTH
        
        ## 🏗️ Project Structure
        \`\`\`
        $(tree -I 'node_modules|.git|bin|vendor' -L 3 || find . -type d | head -20)
        \`\`\`
        
        ## 📅 Recent Activity (Last 7 Days)
        \`\`\`
        $(git log --since="1 week ago" --oneline | head -10)
        \`\`\`
        
        ## 🎯 Top Contributors (Last 30 Days)
        \`\`\`
        $(git log --since="1 month ago" --format='%aN' | sort | uniq -c | sort -rn | head -5)
        \`\`\`
        
        ## 📊 Service Statistics
        - **User Service:** $(find ./internal/user -name "*.go" | wc -l) Go files
        - **Product Service:** $(find ./internal/product -name "*.go" | wc -l) Go files
        - **Basket Service:** $(find ./internal/basket -name "*.go" | wc -l) Go files
        - **Payment Service:** $(find ./internal/payment -name "*.go" | wc -l) Go files
        
        ## 🚀 Performance Metrics
        - **Build Time:** $(date '+%Y-%m-%d %H:%M:%S')
        - **Last Successful Build:** ✅
        - **Test Coverage:** 🔄 (To be implemented)
        
        ---
        *Generated by Analytics Bot 📊*
        EOF
        
        echo "📊 Analytics report generated"
    
    - name: Create performance dashboard
      run: |
        echo "📈 Creating performance dashboard..."
        
        # Create dashboard data
        cat > dashboard-data.json << EOF
        {
          "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "metrics": {
            "total_commits": $TOTAL_COMMITS,
            "commits_this_week": $COMMITS_THIS_WEEK,
            "commits_this_month": $COMMITS_THIS_MONTH,
            "total_contributors": $CONTRIBUTORS,
            "total_go_files": $GO_FILES,
            "total_lines_of_code": $TOTAL_LINES,
            "project_size": "$PROJECT_SIZE"
          },
          "services": {
            "user_service": {
              "go_files": $(find ./internal/user -name "*.go" | wc -l),
              "endpoints": 8,
              "status": "active"
            },
            "product_service": {
              "go_files": $(find ./internal/product -name "*.go" | wc -l),
              "endpoints": 12,
              "status": "active"
            },
            "basket_service": {
              "go_files": $(find ./internal/basket -name "*.go" | wc -l),
              "endpoints": 6,
              "status": "active"
            },
            "payment_service": {
              "go_files": $(find ./internal/payment -name "*.go" | wc -l),
              "endpoints": 10,
              "status": "development"
            }
          }
        }
        EOF
        
        echo "📈 Dashboard data created"
    
    - name: Commit analytics
      run: |
        echo "💾 Committing analytics data..."
        
        git config --local user.email "bot@ddd-micro.com"
        git config --local user.name "📊 Analytics Bot"
        
        # Commit analytics report
        git add analytics-report-*.md dashboard-data.json
        git commit -m "📊 Auto-analytics: Weekly project analytics report

        - Generated comprehensive project statistics
        - Updated performance dashboard data
        - Commits this week: $COMMITS_THIS_WEEK
        - Total contributors: $CONTRIBUTORS
        - Auto-committed by analytics bot" || echo "No changes to commit"
        
        git push || echo "Nothing to push"
        echo "✅ Analytics data committed"
    
    - name: Create weekly summary issue
      run: |
        echo "📋 Creating weekly summary issue..."
        
        # Create GitHub issue with analytics summary
        gh issue create \
          --title "📊 Weekly Project Summary - $(date '+%Y-%m-%d')" \
          --body "## 📈 Weekly Project Analytics
        
        ### Code Statistics
        - **Total Go Files:** $GO_FILES
        - **Total Lines of Code:** $TOTAL_LINES
        - **Commits This Week:** $COMMITS_THIS_WEEK
        - **Total Contributors:** $CONTRIBUTORS
        
        ### Recent Activity
        \`\`\`
        $(git log --since="1 week ago" --oneline | head -5)
        \`\`\`
        
        ### Service Status
        - ✅ User Service: Active
        - ✅ Product Service: Active  
        - ✅ Basket Service: Active
        - 🔄 Payment Service: In Development
        
        ---
        *This summary was automatically generated by Analytics Bot 📊*" \
          --label "analytics,weekly-summary,bot"
      
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
