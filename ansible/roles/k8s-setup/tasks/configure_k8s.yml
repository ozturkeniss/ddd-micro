---
# Kubernetes Configuration Tasks

- name: "Configure swap"
  shell: |
    swapoff -a
    sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
  args:
    creates: /etc/fstab.swapoff

- name: "Load kernel modules"
  modprobe:
    name: "{{ item }}"
  loop:
    - br_netfilter
    - ip_vs
    - ip_vs_rr
    - ip_vs_wrr
    - ip_vs_sh
    - nf_conntrack

- name: "Make kernel modules persistent"
  lineinfile:
    path: /etc/modules-load.d/k8s.conf
    line: "{{ item }}"
    create: yes
  loop:
    - br_netfilter
    - ip_vs
    - ip_vs_rr
    - ip_vs_wrr
    - ip_vs_sh
    - nf_conntrack

- name: "Configure sysctl for Kubernetes"
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: "net.bridge.bridge-nf-call-iptables", value: "1" }
    - { key: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
    - { key: "net.ipv4.ip_forward", value: "1" }
    - { key: "vm.swappiness", value: "0" }
    - { key: "vm.overcommit_memory", value: "1" }
    - { key: "vm.panic_on_oom", value: "0" }
    - { key: "fs.inotify.max_user_instances", value: "8192" }
    - { key: "fs.inotify.max_user_watches", value: "1048576" }
    - { key: "fs.file-max", value: "52706963" }
    - { key: "fs.nr_open", value: "52706963" }
    - { key: "net.netfilter.nf_conntrack_max", value: "2310720" }

- name: "Create sysctl configuration file"
  copy:
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
      vm.swappiness = 0
      vm.overcommit_memory = 1
      vm.panic_on_oom = 0
      fs.inotify.max_user_instances = 8192
      fs.inotify.max_user_watches = 1048576
      fs.file-max = 52706963
      fs.nr_open = 52706963
      net.netfilter.nf_conntrack_max = 2310720
    dest: /etc/sysctl.d/k8s.conf

- name: "Configure limits for Kubernetes"
  pam_limits:
    domain: "*"
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop:
    - { type: "soft", item: "nofile", value: "65536" }
    - { type: "hard", item: "nofile", value: "65536" }
    - { type: "soft", item: "nproc", value: "65536" }
    - { type: "hard", item: "nproc", value: "65536" }
    - { type: "soft", item: "memlock", value: "unlimited" }
    - { type: "hard", item: "memlock", value: "unlimited" }

- name: "Create kubelet limits configuration"
  copy:
    content: |
      kubelet soft nofile 65536
      kubelet hard nofile 65536
      kubelet soft nproc 65536
      kubelet hard nproc 65536
      kubelet soft memlock unlimited
      kubelet hard memlock unlimited
    dest: /etc/security/limits.d/kubelet.conf

- name: "Configure time synchronization"
  systemd:
    name: systemd-timesyncd
    enabled: yes
    state: started

- name: "Configure timezone"
  timezone:
    name: "{{ timezone }}"
